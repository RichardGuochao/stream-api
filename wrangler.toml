name = "stream-api"
main = "src/index.ts"
# 2024-09-23+ required so Node built-ins (http, stream, etc.) resolve when using nodejs_compat
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]

# Observability: persist logs and telemetry in the Workers dashboard
# https://developers.cloudflare.com/workers/observability/
[observability]
enabled = true
# head_sampling_rate: 0 = no requests logged, 1 = 100% (default). Use e.g. 0.1 for 10% to reduce volume.
head_sampling_rate = 1

# R2 Bucket binding for video storage
[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "video-uploads"

# D1 Database binding for metadata
[[d1_databases]]
binding = "DB"
database_name = "video_streaming_db"
database_id = "e63e4c58-d582-4b27-a6fa-4d1abfe590a8"

# =============================================================================
# Environment Variables
# =============================================================================
# These can be configured in the Cloudflare Dashboard instead of here:
#   Workers & Pages → your worker → Settings → Variables and Secrets
#
# If you prefer to set them here, uncomment and fill in the values below.
# =============================================================================

[vars]
# GOOGLE_CLIENT_ID: Your Google OAuth 2.0 Client ID
#   - Used to verify Google ID tokens during login (POST /auth/google)
#   - Get from: Google Cloud Console → APIs & Services → Credentials
GOOGLE_CLIENT_ID = "your-google-client-id"

# CLOUDFLARE_ACCOUNT_ID: Your Cloudflare Account ID (found in dashboard sidebar)
#   - Used for R2 presigned upload URLs (S3 endpoint: https://{accountId}.r2.cloudflarestorage.com)
#   - Used for Cloudflare Stream API calls (live streaming endpoints)
#   - Used to build stream embed URLs
# CLOUDFLARE_ACCOUNT_ID = "your-account-id"

# R2_BUCKET_NAME: Name of your R2 bucket for video storage
#   - Must match the bucket_name in [[r2_buckets]] above
R2_BUCKET_NAME = "video-uploads"

# CORS_ORIGINS: Comma-separated list of allowed origins for CORS
#   - Set to your Cloudflare Pages frontend URL(s)
#   - Example: "https://your-app.pages.dev"
#   - Multiple: "https://your-app.pages.dev,https://yourdomain.com"
#   - If unset, defaults to http://localhost:5173 and http://localhost:8787
CORS_ORIGINS = "https://stream-play-cdd.pages.dev"

# R2_PUBLIC_URL (optional): Public URL for your R2 bucket
#   - If set, GET /videos/:id returns playback_url using this base URL
#   - Example: "https://videos.yourdomain.com" or R2 public bucket URL
# R2_PUBLIC_URL = "https://your-r2-public-url"

# =============================================================================
# Secrets (must be set via Cloudflare Dashboard or `wrangler secret put`)
# =============================================================================
# These should NOT be stored in this file. Set them in:
#   Dashboard: Workers & Pages → your worker → Settings → Variables and Secrets
#   Or CLI: npx wrangler secret put SECRET_NAME
#
# Required secrets:
#   - JWT_SECRET: Random string (32+ chars) for signing JWT tokens
#   - GOOGLE_CLIENT_SECRET: From Google Cloud Console (OAuth credentials)
#   - CLOUDFLARE_STREAM_API_TOKEN: For live streaming (Cloudflare API Tokens)
#   - R2_ACCESS_KEY_ID: For presigned upload URLs (R2 → Manage API Tokens)
#   - R2_SECRET_ACCESS_KEY: For presigned upload URLs (R2 → Manage API Tokens)
# =============================================================================

[env.production]
name = "video-streaming-api-prod"
GOOGLE_CLIENT_ID = "903794417748-qm5vk31lkq3f9vufupb23gthicuvvnks.apps.googleusercontent.com"
R2_BUCKET_NAME = "video-uploads"
CORS_ORIGINS = "https://stream-play-cdd.pages.dev"
